<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>路径评价</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link href="../css/mui.min.css" rel="stylesheet">
		<script src="../js/mui.min.js"></script>

		<link rel="stylesheet" type="text/css" href="../css/base.css" />
		<script src="../js/base.js" type="text/javascript" charset="utf-8"></script>

		<style>
			#map {
				width: 100%;
				position: absolute;
				top: 48px;
				bottom: 70px;
				line-height: 200px;
				text-align: center;
				background: #FFFFFF;
			}
			.footer {
				position: absolute;
				bottom: 0;
				left: 0;
				right: 0;
			}
			.footer a {
				padding: 10px;
				margin-bottom: 8px;
			}
			.footer span {
				font-size: 20px;
				position: relative;
				top: -2px;
			}
			.footer .img-icon {
				width: 25px;
				position: relative;
				top: 3px;
			}
		</style>
		<script src="../js/common.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			var ws = null,
				wo = null;
			var em = null,
				map = null;
			 // H5 plus事件处理
			function plusReady() {
				//				if (!em || ws) {
				//					return
				//				};
				// 获取窗口对象
				ws = plus.webview.currentWebview();
				wo = ws.opener();
				setTimeout(function() {
					map = new plus.maps.Map("map");
					map.getUserLocation(function(state, pos) {
						map.showUserLocation(true);
						map.centerAndZoom(new plus.maps.Point(pos.getLng(), pos.getLat()), 18);
					});
					//					createMarker();
					// 创建子窗口
					//createSubview();
				}, 300);
				// 显示页面并关闭等待框
				ws.show("slide-in-right", 300);
			}
			if (window.plus) {
				plusReady();
			} else {
				document.addEventListener("plusready", plusReady, false);
			}
			 // DOMContentloaded事件处理
			document.addEventListener("DOMContentLoaded", function() {
				em = document.getElementById("map");
				window.plus && plusReady();
			}, false);

			function userLocation() {
				map.showUserLocation(true);
				map.getUserLocation(function(state, pos) {
					//					console.log(state)
					//					console.log(pos.getLat() + "====" + pos.getLng())
					if (0 == state) {
						map.centerAndZoom(new plus.maps.Point(pos.getLng(), pos.getLat()), 18);
						//						map.setCenter(pos);
						//						map.setZoom(18);
					}
				});
			}

			function createMarker() {
				map.getUserLocation(function(state, pos) {
					var marker = new plus.maps.Marker(new plus.maps.Point(pos.getLng(), pos.getLat()));
					marker.setIcon("/logo.png");
					marker.setLabel("起点");
					var bubble = new plus.maps.Bubble("起点");
					marker.setBubble(bubble);
					map.addOverlay(marker);
				});
			}

			function createSubview() {
				if ('Android' != plus.os.name) {
					return;
				}
				var wsub = plus.webview.create('map_sub.html', 'sub', {
					top: '46px',
					height: '34px',
					position: 'absolute',
					scrollIndicator: 'none',
					background: 'transparent'
				});
				ws.append(wsub);
			}

			function resetMap() {
				map.centerAndZoom(new plus.maps.Point(116.666755, 40.16814), 12);
			}
			var path = {};
			path.sadd = ""; //开始地址
			path.sdate = ""; //开始时间
			path.slon = ""; //开始经度
			path.slat = ""; //开始纬度
			path.eadd = ""; //结束地址
			path.edate = ""; //结束时间
			path.elon = ""; //结束经度
			path.elat = ""; //结束纬度
			path.distance = ""; //步行距离
			path.costtime = ""; //步行时间
			path.proce = ""; //起点和终点之间的坐标
			path.kpi1 = ""; //kpi1
			path.kpi2 = ""; //kpi2
			path.kpi3 = ""; //kpi3
			path.kpi = ""; //kpi
			path.suggest = ""; //个人建议
			var recorded = false;
			var points = new Array();

			function toRecord() {
				if (recorded) {
					if (confirm("您确认停止记录吗?")) {
						recorded = false;
						map.getUserLocation(function(state, pos) {
							path.elon = pos.getLng();
							path.elat = pos.getLat()
							path.edate = new Date();
							path.costtime = path.edate - path.sdate;
							path.proce = points;
							var marker = new plus.maps.Marker(new plus.maps.Point(pos.getLng(), pos.getLat()));
							marker.setIcon("/logo.png");
							marker.setLabel("终点");
							//						var bubble = new plus.maps.Bubble("起点");
							//						marker.setBubble(bubble);
							map.addOverlay(marker);
							document.getElementById("img-icon").src = "../images/icons/start.png";
							document.getElementById("record").innerHTML = "开始记录";
							mui.ajax("http://api.map.baidu.com/geocoder?location=" + pos.getLat() + "," + pos.getLng() + "&output=json&key=" + mapkey, {
								dataType: 'json', //服务器返回json格式数据
								type: 'get', //HTTP请求类型
								timeout: 15000, //超时时间设置为15秒；
								success: function(result) {
									//服务器返回响应，根据响应结果，分析是否请求成功；
									if (result.status == "OK") {
										path.eadd = result.result.formatted_address;
										//console.log(JSON.stringify(path));
										map.hide();
										mui('.mui-popover').popover('toggle');
									} else {
										alert("无法获取当前位置，请打开定位服务");
									}
								},
								error: function(xhr, type, errorThrown) {
									//异常处理；
									console.log(type);
									alert("定位服务异常，请稍后再试！");
								}
							});
						});
					}
				} else {
					recorded = true;
					map.getUserLocation(function(state, pos) {
						path.slon = pos.getLng();
						path.slat = pos.getLat()
						path.sdate = new Date();
						var marker = new plus.maps.Marker(new plus.maps.Point(pos.getLng(), pos.getLat()));
						marker.setIcon("/logo.png");
						marker.setLabel("起点");
						//						var bubble = new plus.maps.Bubble("起点");
						//						marker.setBubble(bubble);
						map.addOverlay(marker);
						document.getElementById("img-icon").src = "../images/icons/stop.png";
						document.getElementById("record").innerHTML = "停止记录";
						mui.ajax("http://api.map.baidu.com/geocoder?location=" + pos.getLat() + "," + pos.getLng() + "&output=json&key=" + mapkey, {
							dataType: 'json', //服务器返回json格式数据
							type: 'get', //HTTP请求类型
							timeout: 15000, //超时时间设置为15秒；
							success: function(result) {
								//服务器返回响应，根据响应结果，分析是否请求成功；
								if (result.status == "OK") {
									path.sadd = result.result.formatted_address;
								} else {
									alert("无法获取当前位置，请打开定位服务");
								}
							},
							error: function(xhr, type, errorThrown) {
								//异常处理；
								console.log(type);
								alert("定位服务异常，请稍后再试！");
							}
						});
					});
					//i=0时，坐标不变。测试时改为1
					var i = 1;
					window.setInterval(function() {
						if (recorded) {
							map.getUserLocation(function(state, pos) {
								points.push(new plus.maps.Point(pos.getLng() + i * 0.0001, pos.getLat() + i * 0.0001));
								var polylineObj = new plus.maps.Polyline(points);
								map.centerAndZoom(new plus.maps.Point(pos.getLng() + i * 0.0001, pos.getLat() + i * 0.0001), 18);
								polylineObj.setStrokeColor("#00FF00");
								polylineObj.setLineWidth(8);
								map.addOverlay(polylineObj);
								i++;
							});
						}
					}, 3000);
				}
			}

			function submit() {
				var wt = plus.nativeUI.showWaiting();
				mui.ajax(localhost + "walk/service/appPathService/saveAppPath", {
					data: {
						sadd: path.sadd,
						sdate: path.sdate.Format("yyyy-MM-dd hh:mm:ss"),
						slon: path.slon,
						slat: path.slat,
						eadd: path.eadd,
						edate: path.edate.Format("yyyy-MM-dd hh:mm:ss"),
						elon: path.elon,
						elat: path.elat,
						distance: path.distance,
						costtime: path.costtime,
						proce: JSON.stringify(path.proce),
						kpi1: path.kpi1,
						kpi2: path.kpi2,
						kpi3: path.kpi3,
						kpi: path.kpi,
						suggest: path.suggest
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 20000, //超时时间设置为15秒；
					success: function(result) {
						//服务器返回响应，根据响应结果，分析是否登录成功；
						if (result.success) {
							if (result.data.code == "S001") {
								alert(result.data.msg);
								wt.close();
								mui.back();
							} else {
								alert(result.data.msg);
							}
						} else {
							alert("服务异常，请稍后再试！");
						}
					},
					error: function(xhr, type, errorThrown) {
						//异常处理；
						console.log(type);
						alert("服务异常，请稍后再试！");
					}
				});
			}
			mui('.mui-scroll-wrapper').scroll();
			mui('body').on('shown', '.mui-popover', function(e) {
				//console.log('shown', e.detail.id);//detail为当前popover元素
			});
			mui('body').on('hidden', '.mui-popover', function(e) {
				//console.log('hidden', e.detail.id);//detail为当前popover元素
			});
		</script>
	</head>

	<body>

		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<div class="mui-icon mui-icon-right-nav mui-pull-right mui-icon-location" onclick="userLocation();"></div>
			<h1 class="mui-title">路径评价</h1>
		</header>

		<div class="mui-content">
			<!--<div id="map">地图加载中...</div>-->
			<div class="footer">
				<!--<a class="mui-btn mui-btn-primary mui-btn-block" onclick="toRecord();">-->
				<a href="#middlePopover" class="mui-btn mui-btn-primary mui-btn-block">
					<img id="img-icon" class="img-icon" src="../images/icons/start.png" />
					<span id="record">开始记录</span>
				</a>
			</div>
		</div>

		<div id="middlePopover" class="mui-popover mui-popover-bottom">
			<div class="mui-popover-arrow"></div>
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<ul class="mui-table-view">
						<li class="mui-table-view-cell"><a href="#">Item1</a>
						</li>
						<li class="mui-table-view-cell"><a href="#">Item2</a>
						</li>
						<li class="mui-table-view-cell"><a href="#">Item3</a>
						</li>
						<li class="mui-table-view-cell"><a href="#">Item4</a>
						</li>
						<li class="mui-table-view-cell"><a href="#">Item5</a>
						</li>
						<li class="mui-table-view-cell"><a href="#">Item6</a>
						</li>
						<li class="mui-table-view-cell"><a href="#">Item7</a>
						</li>
						<li class="mui-table-view-cell"><a href="#">Item8</a>
						</li>
						<li class="mui-table-view-cell"><a href="#">Item9</a>
						</li>
						<li class="mui-table-view-cell"><a href="#">Item10</a>
						</li>
					</ul>
				</div>
			</div>
		</div>

	</body>

</html>